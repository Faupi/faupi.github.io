function Get-Winget-Status {
    (Get-AppxPackage | Where-Object Name -eq Microsoft.DesktopAppInstaller).Status
}

function Install-Winget {
    If ((Get-Winget-Status) -eq "Ok") {
        Write-Output "Winget already installed"
        Return
    }

    Start-Process ms-windows-store://pdp/?ProductId=9NBLGGH4NNS1  # Winget in the MS store
    While ((Get-Winget-Status) -ne "Ok") {
        Start-Sleep 1
    }
    Write-Output "Winget installed OK"
}

function Install-Winget-Packages {
    winget install Microsoft.WindowsTerminal  # Available in Choco but it has permission issues
}

function Install-Choco-Packages {
    choco install -y git --params="'/GitAndUnixToolsOnPath /NoAutoCrlf'"
    
    choco install -y `
        1password vscodium imageglass `
        firefox `
        modernflyouts msiafterburner equalizerapo nilesoft-shell start10 `
        telegram steam discord spotify `
        sharex paint.net

    # choco install icue --version 4.33.138 -y
    # choco install cura-new --version 5.3.0 -y
    # choco install winbox --version 3.37 -y
    # choco install scrcpy --version 2.0 -y
}

# Prompt manual winget installation while choco packages get pulled
$WingetJob = Start-Job -ScriptBlock { Install-Winget }
Install-Choco-Packages

# After winget's ok to go, install its packages
Wait-Job $WingetJob
Install-Winget-Packages
